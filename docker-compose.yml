services:
  # PostgreSQL Database
  postgres:
    image: postgres:18-alpine
    container_name: laundry_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: laundry_app_prod
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
      POSTGRES_DB: laundry_app_prod
    secrets:
      - db_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - backend
    ports:
      - "5432:5432"  # Expose for local development
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U laundry_app_prod"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend Application
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: laundry_backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: 3000
      HOST: 0.0.0.0
      LOG_LEVEL: info
      LOG_FORMAT: json
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_USER: laundry_app_prod
      DATABASE_NAME: laundry_app_prod
      DB_POOL_MIN: 5
      DB_POOL_MAX: 20
      DB_IDLE_TIMEOUT: 30000
      BCRYPT_ROUNDS: 12
      RATE_LIMIT_ENABLED: 'true'
      RATE_LIMIT_SKIP_ADMIN: 'true'
      MAX_BODY_SIZE: 4194304
      MAX_JSON_DEPTH: 10
    env_file:
      - ./backend/.env.production
    networks:
      - backend
      - frontend
    # Security: Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    # Security: Read-only filesystem (except /tmp)
    read_only: true
    tmpfs:
      - /tmp
    # Security: No new privileges
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:3000/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3

  # Nginx Reverse Proxy
  nginx:
    image: nginx:1.27-alpine
    container_name: laundry_nginx
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    networks:
      - frontend
    # Security: Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    # Security: Read-only filesystem (except cache and logs)
    read_only: true
    tmpfs:
      - /var/run
      - /var/cache/nginx
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3

networks:
  # Backend network (postgres <-> backend)
  # Note: internal=false for local development (allows port exposure)
  # Set to internal=true in production
  backend:
    driver: bridge
    internal: false
  # Frontend network (nginx <-> backend)
  frontend:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  nginx_logs:
    driver: local

secrets:
  db_password:
    file: ./secrets/db_password.txt
